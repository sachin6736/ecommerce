<%- include('header', { admin: admin }) %>
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<style>
    .container {
        width: 80%;
        margin: auto;
        padding: 20px;
        background-color: #868686a9;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .container h1 {
        text-align: center;
        margin-bottom: 20px;
    }

     .subcategory-table {
        width: 100%;
        border-collapse: collapse;
    }

    .btn-delete {
        background-color: #d9534f;
        color: white;
        border: none;
        /* padding: 1px 10px; */
        cursor: pointer;
    }

    .btn-delete:hover {
        background-color: #c9302c;
    }

    .category-table {
        width: 100%;
        background-color: #bbb;
        border-collapse: collapse;
    }

    .category-table th, .category-table td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: left;
    }

    .category-table th {
        background-color: #f2f2f2;
    }

    .category-title {
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        position: relative;
    }

    .product_count {
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        position: relative;
    }
/* 
    .subcategory-list {
        display: none;
        margin: 5px 0;
        padding-left: 20px;
        list-style: none;
    }

    .subcategory-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 5px 0;
    } */

    .btn-delete, .btn-edit {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 3px;
        
        cursor: pointer;
    }

    .btn-delete {
        background-color: #ff4d4f;
    }

    .btn-delete:hover {
        background-color: #ff1a1a;
    }

    .btn-edit:hover {
        background-color: #0056b3;
    }

    .category_btn {
        display: block;
        width: 100%;
        padding: 10px;
        margin: 20px 0;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 5px;
        text-align: center;
        cursor: pointer;
    }

    .category_btn:hover {
        background-color: #216288;
    }

    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #000000b9;
        z-index: 1000;
        display: none;
        justify-content: center;
        align-items: center;
    }

    .popup {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
    }

    .popup h2 {
        text-align: center;
        margin-bottom: 20px;
        color: #333;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .form-group input {
        width: calc(100% - 12px);
        padding: 8px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .btn-group {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }

    .btn-submit,
    .btn-cancel {
        padding: 10px 20px;
        font-size: 14px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .btn-submit {
        color: #fff;
        background-color: #007bff;
    }

    .btn-submit:hover {
        background-color: #0056b3;
    }

    .btn-cancel {
        color: #333;
        background-color: #ccc;
    }

    .btn-cancel:hover {
        background-color: #bbb;
    }
</style>

<div class="container">
    <h1>Manage Categories</h1>
   
    <table class="category-table">
        <thead>
            <tr>
                <th>Category</th>
                <th>Product Count</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <% Categories.forEach(category => { %>
                <tr class="category-item">
                    <td class="category-title" onclick="list_subcategories('<%= category._id %>')">
                        <img style="max-width: 300px;" src="/Product_images/<%= category.image %>" alt="">
                        <%= category.name %>
                    </td>
                    <td class="product_count">
                        <% product_detail.forEach(product => { %>
                            <% if (product._id.toString() === category._id.toString()) { %>
                                <%= product.product_details.length %>
                            <% } %>
                        <% }) %> 
                    </td>
                    <td class="category-actions">
                        <button id="edit" class="btn-edit" onclick="editCategory('<%= category._id %>', '<%= category.name %>')">Edit</button>
                        <button id="delete" class="btn-delete" onclick="delete_category('<%= category._id %>')">Delete</button>
                    </td>
                </tr>
                <tr id="subcategories-row-<%=category._id %>" style="display: none;">
                    <td colspan="3">
                        <table class="subcategory-table">
                            <thead>
                                <tr>
                                    <th>Subcategories</th>
                                    <th>Product Count</th>
                                    <th>Actions</th>                                  
                                </tr>
                            </thead>
                        
                                <% Subcategories.forEach(subcategory => { %>
                                    <% if (category._id.toString() === subcategory.category_Id.toString()) { %>
                                        <tr class="subcategory-item">
                                            <td><%= subcategory.name %></td>
                                            <td>
                                                <% let Products_Count = Product_Detail.find(p => p._id.toString() === subcategory._id.toString()); %>
                                                <%= Products_Count ? Products_Count.Product_Detail.length : 0 %>
                                            </td>
                                            <td>
                                                <button class="btn-edit" onclick="edit_Subcategory('<%= subcategory._id %> ','<%= subcategory.name  %>')">Edit</button>
                                                <button class="btn-delete" onclick="deleteSubcategory('<%= subcategory._id %>')">Delete</button>
                                            </td>
                                        </tr>
                                    <% } %>
                                <% }) %>
                            </tbody>
                        </table>
                    </td>
                </tr>
            <% }) %>
        </tbody>
    </table>
    <button class="category_btn" onclick="window.location.href='/Add_categories'">Add Categories</button>
</div>

<div class="overlay" id="overlay">
    <div class="popup">
        <h2>Edit Category</h2>
        <form id="editForm">
            <div class="form-group">
                <div class="square-upload">
                    <input type="file" name="image" id="image" >
                    <label for="image" class="upload-label">                   
                    </label>
                </div>
                
                <label for="editName">Category Name:</label>
                <input id="editid" type="hidden" value="categoryId">
                <input type="text" id="editName" name="editName" required>
            </div>
            <div class="btn-group">
                <button type="button" class="btn-submit" onclick="submitEditForm()">Save Changes</button>
                <button type="button" class="btn-cancel"  onclick="closeEditForm()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div class="overlay" id="edit_subcategoryform">
    <div class="popup">
        <h2>Edit  Sub Category</h2>
        <form id="editForm"   >
            <div class="form-group">
                
                
                <label for="editName">Sub Category Name:</label>
                <input id="editsubid" type="hidden" value="categoryId">
                <input type="text" id="editsubName" name="editName" required>
            </div>
            <div class="btn-group">
                <button type="button" class="btn-submit" onclick="submit_Subcategoryeditform()">Save Changes</button>
                <button type="button" class="btn-cancel" onclick="closeEdit_subcategorytForm()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
  
  function list_subcategories(categoryId) {
    console.log("start")
        var subcategoryRow = document.getElementById(`subcategories-row-${categoryId}`);
        if (subcategoryRow) {
    console.log("stcondithuygtuvhart")

            subcategoryRow.style.display = subcategoryRow.style.display === 'none' ? '' : 'none';
        }
    }

 

    function editCategory(categoryId, categoryName) {
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById("editid").value = categoryId;
        document.getElementById("editName").value = categoryName;
    }

    function edit_Subcategory(subacategoryId,subCategoryName){
    document.getElementById('edit_subcategoryform').style.display = 'flex'
    document.getElementById("editsubid").value = subacategoryId;
    document.getElementById("editsubName").value = subCategoryName
  
    }

    async function submit_Subcategoryeditform()
    {
     subcategoryId = document.getElementById('editsubid').value
     subCategoryName = document.getElementById('editsubName').value
   const req_body = {name:subCategoryName}
      
 const response = await fetch(`/edit_subcategory/${subcategoryId}`,{
    method:'PUT',
    body:JSON.stringify(req_body),
    headers: {  'Content-Type': 'application/json'}
   })

   const updated =await  response.json()
   if(updated)
   {
    document.getElementById('edit_subcategoryform').style.display='none'
    location.reload()
   }
    }
    async function submitEditForm() {
        try{
            let image = document.getElementById('image');
            let category_id = document.getElementById('editid').value;
            let updated_name = document.getElementById('editName').value; 
            let form = document.getElementById("editForm");

            // image_File = image.files[0];
            // console.log(image_File)

            let formData = new FormData(form);
            let request_body = JSON.stringify({ categoryName: updated_name, categoryId: category_id})

      
           
            formData.append('req_body',request_body)

            const response = await fetch(`/edit_category/${category_id}`, {
                method: 'PUT',
                body: formData,            
            });
            console.log(response)

            if (response.ok) {
                const data = await response.json();
                if (data) {
                    document.getElementById('overlay').style.display = 'none';
                    location.reload();
                }
            } else {
                console.log("Error updating category");
            }
        } catch (error) {
            console.log(error.message);
         
    }
}

    function closeEditForm() {
        document.getElementById('overlay').style.display = 'none';
    }
    async function delete_category(categoryId) {
    alertify.confirm(
        'Confirm Delete',
        'Are you sure you want to delete this category?',
        async function() {
            // Action if confirmed
            try {
                const response = await fetch(`/delete_category/${categoryId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alertify.success('Category deleted successfully');
                    location.reload(); // Reload the page or update UI
                } else {
                    alertify.error('Failed to delete category');
                }
            } catch (error) {
                console.error('Error:', error);
                alertify.error('An error occurred');
            }
        },
        function() {
            // Action if canceled
            alertify.error('Cancelled');
        }
    ).set('labels', {ok: 'Yes', cancel: 'No'});
}

    async function deleteSubcategory(subcategoryId) {
        Swal.fire({
            title: "Are you sure?",
            text: "You won't be able to revert this!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "Yes, delete it!"
        })
        .then(async (result) => {
            if (result.isConfirmed) {
                const response = await fetch(`/delete_subcategory/${subcategoryId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    Swal.fire({
                        title: "Deleted!",
                        text: "Your file has been deleted.",
                        icon: "success"
                    }).then(() => {
                        location.reload();
                    });
                }
            }
        });
    }
    function closeEdit_subcategorytForm() {
        document.getElementById('edit_subcategoryform').style.display = 'none';
    }
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/alertify.min.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/default.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<%- include('footer') %>
